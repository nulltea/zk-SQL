# zk-SQL
This project provides basic tools and infrastructure for proving the correctness of the SQL queries performed against the database hosted in an untrusted environment.

As a demo, this project implements a platform that connects "data miners" running SQL-prover nodes and users that wish to outsource their data and are willing to pay for such service.

Other use cases of the zk-SQL include running it as an alternative backend for dApps frontends with no additional trust assumptions, on-chain Oracles serving on-demand data to smart contracts in a completely verifiable way, and a "pay-as-you-go" model for trustless private data marketplaces.

## How it works
The integral part of this project is a suite of arithmetic circuits that encode main SQL operations using [iden3/circom](https://github.com/iden3/circom) language. The [`select.circom`](https://github.com/timoth-y/zk-SQL/blob/main/server/circuits/select.circom) represents the primary read operation for querying certain data from a certain table with a certain condition. The write operations include [`insert.circom`](https://github.com/timoth-y/zk-SQL/blob/main/server/circuits/insert.circom), [`update.circom`](https://github.com/timoth-y/zk-SQL/blob/main/server/circuits/update.circom), [`delete.circom`](https://github.com/timoth-y/zk-SQL/blob/main/server/circuits/delete.circom).

As **private inputs**, these circuits commonly take a `table` represented as `nRows` x `nCols` matrix, a `nCols` size `header`. Parameters `fields` and `setFields` are vectors used in `SELECT` and `UPDATE` queries and are expected to always be a subset of `header`. Whenever query has and `WHERE` clause circuit will take `whereConditions` - a matrix where each row is a set of `AND`-separated expressions and each row itself is separated with `OR` operator, and each cell is a `(column, value)` tuple represented a binary equality expression (more conditions are coming).

As **public parameters**, all circuits take `tableCommit` which is a hash of the `table` along with the `header` calculated during the last write operation and is stored in the [`zkSQL.sol`](https://github.com/timoth-y/zk-SQL/blob/main/server/contracts/zkSQL.sol) contract. The `argsCommit` parameter is used similarly for committing to SQL query parameters allowing keeping them private too.

Each circuit will verify the integrity of the private data first by hashing it and comparing it with `tableCommit` and only then simulate operations on the data as prescribed by the SQL query and the underlying parameters. The read operation will output the `results` matrix repressing the selected data. The write operations will instead output the `newTableCommit`, which is the hash of the table after it was modified by the query. All output signals are public.

The verifier (either user for select query or smart contract for write operations) would use public inputs and the generated proof to ensure the correctness of the performed query without having to own the full table data.

## Repository structure
- `circuits`: contains previously described circuits along with `util.circom` and `hashTable.circom` for the common intermediary templets.
- `contracts`: contains autogenerated `*Verifier.sol` contracts for each SQL operation encoded using [PLONK](https://eprint.iacr.org/2019/953.pdf) proving system.
- `server`: source of the SQL-prover node software
    - `src/engine`: tools for bridging embedded [sql.js](https://github.com/sql-js/sql.js) database with [snarkjs](https://github.com/iden3/snarkjs) for operating data tables while producing ZK proofs.
    - `src/controllers/api`: public-facing REST interface based on the [Ts.ED](https://github.com/tsedio/tsed) framework.
    - `src/client`: client for the API and other tools for client-side proof verification.
- `web`: frontend application using SSR based on the [Next.js](https://github.com/vercel/next.js/) framework.

## Instructions
Dependencies:
- Circom 2.0
- Node.js, yarn
- make

Go to server directory and create `.env` file (see example `.env.example`)
```bash
cd ./server && nano .env
```

To install dependencies:
```bash
npm install
```

To build circuits and contract artifacts:
```bash
make build
```

To run dev server:
```bash
npm start
```
